<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Compositional Modeling with Decorated Cospans • openstockflow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Atkinson_Hyperlegible-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Compositional Modeling with Decorated Cospans">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">openstockflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ianmoran11/openstockflow" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Compositional Modeling with Decorated Cospans</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ianmoran11/openstockflow/blob/main/vignettes/composition.Rmd" class="external-link"><code>vignettes/composition.Rmd</code></a></small>
      <div class="d-none name"><code>composition.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ianmoran11/openstockflow" class="external-link">openstockflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the key advantages of the categorical approach to stock-flow
modeling is the ability to <strong>compose</strong> complex models from
simpler components. This vignette demonstrates how to build models
compositionally using decorated cospans and pushout operations.</p>
<div class="section level3">
<h3 id="what-is-composition">What is Composition?<a class="anchor" aria-label="anchor" href="#what-is-composition"></a>
</h3>
<p>Composition allows you to:</p>
<ul>
<li>Build complex systems from simpler, reusable components</li>
<li>Connect models through shared interface stocks</li>
<li>Maintain mathematical rigor through categorical operations</li>
<li>Ensure that composed models have well-defined semantics</li>
</ul>
</div>
<div class="section level3">
<h3 id="mathematical-foundation">Mathematical Foundation<a class="anchor" aria-label="anchor" href="#mathematical-foundation"></a>
</h3>
<p>Composition is based on the categorical pushout operation. When you
compose two diagrams through a shared interface, the system:</p>
<ol style="list-style-type: decimal">
<li>Takes the disjoint union of both diagrams</li>
<li>Identifies (glues together) the stocks in the interface</li>
<li>Preserves all flows from both diagrams</li>
<li>Maintains the categorical structure</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="converting-to-open-diagrams">Converting to Open Diagrams<a class="anchor" aria-label="anchor" href="#converting-to-open-diagrams"></a>
</h2>
<p>Before composition, diagrams must be converted to “open” form by
specifying which stocks are exposed as interfaces.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a simple diagram</span></span>
<span><span class="va">tank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Water"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Spillage"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"leak"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"Water"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"Spillage"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">leak_rate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Water</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Expose "Water" as a right interface (can be composed on the right)</span></span>
<span><span class="va">open_tank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">tank</span>, right_interface <span class="op">=</span> <span class="st">"Water"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You can also specify both left and right interfaces</span></span>
<span><span class="va">open_tank_both</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">tank</span>,</span>
<span>  left_interface <span class="op">=</span> <span class="st">"Water"</span>,</span>
<span>  right_interface <span class="op">=</span> <span class="st">"Spillage"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simple-composition-connected-tanks">Simple Composition: Connected Tanks<a class="anchor" aria-label="anchor" href="#simple-composition-connected-tanks"></a>
</h2>
<p>Let’s compose two tank models to create a connected system.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Left tank: water flows in and can flow to the right</span></span>
<span><span class="va">left_tank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Tank1"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"inflow"</span>,</span>
<span>    from <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># External inflow</span></span>
<span>    to <span class="op">=</span> <span class="st">"Tank1"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">inflow_rate</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Right tank: receives water from the left</span></span>
<span><span class="va">right_tank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Tank2"</span>, initial <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"outflow"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"Tank2"</span>,</span>
<span>    to <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># External outflow</span></span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">outflow_rate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Tank2</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a connecting flow</span></span>
<span><span class="va">connector</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Tank1"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Tank2"</span>, initial <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"transfer"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"Tank1"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"Tank2"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">transfer_rate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Tank1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose: left_tank with connector via Tank1</span></span>
<span><span class="va">left_open</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">left_tank</span>, right_interface <span class="op">=</span> <span class="st">"Tank1"</span><span class="op">)</span></span>
<span><span class="va">connector_open1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">connector</span>,</span>
<span>  left_interface <span class="op">=</span> <span class="st">"Tank1"</span>,</span>
<span>  right_interface <span class="op">=</span> <span class="st">"Tank2"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">step1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">left_open</span>, <span class="va">connector_open1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose: result with right_tank via Tank2</span></span>
<span><span class="va">connector_open2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">right_tank</span>, left_interface <span class="op">=</span> <span class="st">"Tank2"</span><span class="op">)</span></span>
<span><span class="va">final_system</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">step1</span>, <span class="va">connector_open2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Close to get the complete diagram</span></span>
<span><span class="va">complete_system</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/close_diagram.html">close_diagram</a></span><span class="op">(</span><span class="va">final_system</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The complete system has all three stocks and all three flows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Stocks:"</span>, <span class="fu"><a href="../reference/n_stocks.html">n_stocks</a></span><span class="op">(</span><span class="va">complete_system</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Stocks: 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Flows:"</span>, <span class="fu"><a href="../reference/n_flows.html">n_flows</a></span><span class="op">(</span><span class="va">complete_system</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Flows: 3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sir-model-composition">SIR Model Composition<a class="anchor" aria-label="anchor" href="#sir-model-composition"></a>
</h2>
<p>A powerful use case is building epidemic models by composing
transmission and recovery processes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Transmission process: S -&gt; I</span></span>
<span><span class="va">transmission</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">999</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"infection"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"S"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"I"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span> <span class="op">/</span> <span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">+</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Recovery process: I -&gt; R</span></span>
<span><span class="va">recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"R"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"recovery"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"I"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose via shared stock "I"</span></span>
<span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span></span>
<span>  <span class="va">transmission</span>,</span>
<span>  <span class="va">recovery</span>,</span>
<span>  interface <span class="op">=</span> <span class="st">"I"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Close and solve</span></span>
<span><span class="va">sir_closed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/close_diagram.html">close_diagram</a></span><span class="op">(</span><span class="va">sir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The composed model has the correct structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SIR model stocks:"</span>, <span class="fu"><a href="../reference/stock_names.html">stock_names</a></span><span class="op">(</span><span class="va">sir_closed</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; SIR model stocks: S I R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SIR model flows:"</span>, <span class="fu"><a href="../reference/flow_names.html">flow_names</a></span><span class="op">(</span><span class="va">sir_closed</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; SIR model flows: infection recovery</span></span>
<span></span>
<span><span class="co"># Solve the composed model</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span></span>
<span>  <span class="va">sir_closed</span>,</span>
<span>  times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the result</span></span>
<span><span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">result</span>, title <span class="op">=</span> <span class="st">"Composed SIR Model"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">openstockflow</span> package.</span></span>
<span><span class="co">#&gt;   Please report the issue at</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/ianmoran11/openstockflow/issues&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="composition_files/figure-html/sir_composition-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="flow-rate-merging">Flow Rate Merging<a class="anchor" aria-label="anchor" href="#flow-rate-merging"></a>
</h2>
<p>When multiple flows connect to the same interface stock, their rates
are automatically summed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Two sources flowing into a shared reservoir</span></span>
<span><span class="va">source1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Source1"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Reservoir"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"flow1"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"Source1"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"Reservoir"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">rate1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">source2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Source2"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Reservoir"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"flow2"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"Source2"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"Reservoir"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">rate2</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose via shared "Reservoir"</span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">source1</span>, <span class="va">source2</span>, interface <span class="op">=</span> <span class="st">"Reservoir"</span><span class="op">)</span></span>
<span><span class="va">combined_closed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/close_diagram.html">close_diagram</a></span><span class="op">(</span><span class="va">combined</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The reservoir receives both flows</span></span>
<span><span class="co"># dReservoir/dt = rate1 + rate2</span></span>
<span><span class="va">ode_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_ode.html">generate_ode</a></span><span class="op">(</span><span class="va">combined_closed</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initial_state.html">initial_state</a></span><span class="op">(</span><span class="va">combined_closed</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rate1 <span class="op">=</span> <span class="fl">5</span>, rate2 <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># At t=0, dReservoir/dt = 5 + 3 = 8</span></span>
<span><span class="va">deriv</span> <span class="op">&lt;-</span> <span class="fu">ode_func</span><span class="op">(</span><span class="fl">0</span>, <span class="va">state</span>, <span class="va">params</span><span class="op">)</span></span>
<span><span class="va">reservoir_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="../reference/stock_names.html">stock_names</a></span><span class="op">(</span><span class="va">combined_closed</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Reservoir"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"dReservoir/dt ="</span>, <span class="va">deriv</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">reservoir_idx</span><span class="op">]</span>, <span class="st">"(expected: 8)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; dReservoir/dt = 8 (expected: 8)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="associativity-chaining-compositions">Associativity: Chaining Compositions<a class="anchor" aria-label="anchor" href="#associativity-chaining-compositions"></a>
</h2>
<p>Composition is associative, meaning you can compose multiple diagrams
in any order.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create three simple diagrams</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"X"</span>, initial <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Y"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Y"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Z"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"Z"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"W"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose left-to-right: (A ∘ B) ∘ C</span></span>
<span><span class="co"># Use explicit open diagrams to control interfaces</span></span>
<span><span class="va">a_open</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">a</span>, right_interface <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">b_open1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">b</span>, left_interface <span class="op">=</span> <span class="st">"Y"</span>, right_interface <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span></span>
<span><span class="va">ab</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">a_open</span>, <span class="va">b_open1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c_open1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">c</span>, left_interface <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span></span>
<span><span class="va">abc_left</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">ab</span>, <span class="va">c_open1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose right-to-left: A ∘ (B ∘ C)</span></span>
<span><span class="va">b_open2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">b</span>, left_interface <span class="op">=</span> <span class="st">"Y"</span>, right_interface <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span></span>
<span><span class="va">c_open2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">c</span>, left_interface <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span></span>
<span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">b_open2</span>, <span class="va">c_open2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a_open2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_open_diagram.html">as_open_diagram</a></span><span class="op">(</span><span class="va">a</span>, right_interface <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">abc_right</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span><span class="va">a_open2</span>, <span class="va">bc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both result in the same structure (up to ID renaming)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Left association stocks:"</span>, <span class="fu"><a href="../reference/n_stocks.html">n_stocks</a></span><span class="op">(</span><span class="fu"><a href="../reference/close_diagram.html">close_diagram</a></span><span class="op">(</span><span class="va">abc_left</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Left association stocks: 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Right association stocks:"</span>, <span class="fu"><a href="../reference/n_stocks.html">n_stocks</a></span><span class="op">(</span><span class="fu"><a href="../reference/close_diagram.html">close_diagram</a></span><span class="op">(</span><span class="va">abc_right</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Right association stocks: 4</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="design-patterns-for-reusable-components">Design Patterns for Reusable Components<a class="anchor" aria-label="anchor" href="#design-patterns-for-reusable-components"></a>
</h2>
<div class="section level3">
<h3 id="pattern-1-stratified-models">Pattern 1: Stratified Models<a class="anchor" aria-label="anchor" href="#pattern-1-stratified-models"></a>
</h3>
<p>Create age-stratified models by composing identical structures for
each age group.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to create a single age group</span></span>
<span><span class="va">create_age_group</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">age_name</span>, <span class="va">initial_S</span>, <span class="va">initial_I</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"S_"</span>, <span class="va">age_name</span><span class="op">)</span>, initial <span class="op">=</span> <span class="va">initial_S</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>, <span class="va">age_name</span><span class="op">)</span>, initial <span class="op">=</span> <span class="va">initial_I</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"R_"</span>, <span class="va">age_name</span><span class="op">)</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"infection_"</span>, <span class="va">age_name</span><span class="op">)</span>,</span>
<span>      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"S_"</span>, <span class="va">age_name</span><span class="op">)</span>,</span>
<span>      to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>, <span class="va">age_name</span><span class="op">)</span>,</span>
<span>      rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Age-specific transmission rate</span></span>
<span>        <span class="va">params</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"beta_"</span>, <span class="va">age_name</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>          <span class="va">inputs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"S_"</span>, <span class="va">age_name</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>          <span class="va">inputs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>, <span class="va">age_name</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create age groups</span></span>
<span><span class="va">children</span> <span class="op">&lt;-</span> <span class="fu">create_age_group</span><span class="op">(</span><span class="st">"child"</span>, <span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">adults</span> <span class="op">&lt;-</span> <span class="fu">create_age_group</span><span class="op">(</span><span class="st">"adult"</span>, <span class="fl">2000</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># These can be composed or analyzed separately</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pattern-2-modular-interventions">Pattern 2: Modular Interventions<a class="anchor" aria-label="anchor" href="#pattern-2-modular-interventions"></a>
</h3>
<p>Build intervention components that can be added to base models.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base SIR model</span></span>
<span><span class="va">base_sir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">999</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"R"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"infection"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"S"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"I"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span> <span class="op">/</span> <span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">+</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span> <span class="op">+</span> <span class="va">inputs</span><span class="op">$</span><span class="va">R</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"recovery"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"I"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Vaccination intervention (moves S -&gt; R directly)</span></span>
<span><span class="va">vaccination</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span>reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">999</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"R"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"vaccination"</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"S"</span>,</span>
<span>    to <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">vax_rate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">S</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose to add vaccination to the model</span></span>
<span><span class="va">sir_with_vax</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose.html">compose</a></span><span class="op">(</span></span>
<span>  <span class="va">base_sir</span>,</span>
<span>  <span class="va">vaccination</span>,</span>
<span>  interface <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"R"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Compositional modeling with openstockflow enables:</p>
<ul>
<li>
<strong>Modularity</strong>: Build complex models from simple,
reusable components</li>
<li>
<strong>Mathematical rigor</strong>: Composition follows categorical
laws (associativity, identity)</li>
<li>
<strong>Flow merging</strong>: Automatically handles multiple flows
to interface stocks</li>
<li>
<strong>Flexibility</strong>: Compose in any order, create libraries
of reusable components</li>
</ul>
<p>Key functions:</p>
<ul>
<li>
<code><a href="../reference/as_open_diagram.html">as_open_diagram()</a></code>: Convert a diagram to open form with
interfaces</li>
<li>
<code><a href="../reference/compose.html">compose()</a></code>: Compose two diagrams via a shared
interface</li>
<li>
<code><a href="../reference/close_diagram.html">close_diagram()</a></code>: Extract the underlying diagram from an
open diagram</li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p>Baez, J. C., Li, X., Libkind, S., Osgood, N., &amp; Redekopp, E.
(2022). <em>Compositional modeling with stock and flow diagrams.</em>
arXiv:2205.08373</p></li>
<li><p>Libkind, S., Baas, A., Halter, M., Patterson, E., &amp;
Fairbanks, J. (2022). <em>An algebraic framework for structured epidemic
modeling.</em> arXiv:2211.01290</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Moran.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
