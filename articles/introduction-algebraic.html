<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to openstockflow (Algebraic API) ‚Ä¢ openstockflow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Atkinson_Hyperlegible-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to openstockflow (Algebraic API)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">openstockflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ianmoran11/openstockflow" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to openstockflow (Algebraic API)</h1>
                        <h4 data-toc-skip class="author">Ian Moran</h4>
            
            <h4 data-toc-skip class="date">2025-12-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ianmoran11/openstockflow/blob/main/vignettes/introduction-algebraic.Rmd" class="external-link"><code>vignettes/introduction-algebraic.Rmd</code></a></small>
      <div class="d-none name"><code>introduction-algebraic.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><strong>openstockflow</strong> is the first R package to implement
categorical stock-flow modeling using decorated cospans and functorial
semantics. This approach, pioneered in the StockFlow.jl Julia package,
enables compositional model building where complex systems are assembled
from simpler components through categorical operations.</p>
<p>This introduction demonstrates the <strong>algebraic API</strong>,
which uses mathematical operators and categorical notation for model
construction.</p>
<div class="section level3">
<h3 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a>
</h3>
<ul>
<li>
<strong>Compositional modeling</strong>: Build complex models from
simple components</li>
<li>
<strong>Functorial semantics</strong>: Formal separation of diagram
syntax from ODE semantics</li>
<li>
<strong>Algebraic notation</strong>: Mathematical operators
<code>%-&gt;%</code> and <code>%+%</code> for intuitive model
building</li>
<li>
<strong>Integration</strong>: Seamless integration with deSolve for
ODE solving</li>
<li>
<strong>Visualization</strong>: Multiple visualization options
including ggraph and Graphviz</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install from GitHub (when available)</span></span>
<span><span class="co"># devtools::install_github("ianmoran/openstockflow")</span></span>
<span></span>
<span><span class="co"># For now, load from source</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ianmoran11/openstockflow" class="external-link">openstockflow</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-concepts">Basic Concepts<a class="anchor" aria-label="anchor" href="#basic-concepts"></a>
</h2>
<div class="section level3">
<h3 id="stock-flow-diagrams">Stock-Flow Diagrams<a class="anchor" aria-label="anchor" href="#stock-flow-diagrams"></a>
</h3>
<p>A <strong>stock-flow diagram</strong> consists of:</p>
<ul>
<li>
<strong>Stocks</strong> (rectangles): State variables representing
accumulations</li>
<li>
<strong>Flows</strong> (thick arrows): Rate processes that move
quantities between stocks</li>
<li>
<strong>Links</strong> (thin arrows): Information dependencies</li>
<li>
<strong>Variables</strong>: Auxiliary computations and
aggregations</li>
</ul>
</div>
<div class="section level3">
<h3 id="mathematical-foundation">Mathematical Foundation<a class="anchor" aria-label="anchor" href="#mathematical-foundation"></a>
</h3>
<p>Stock-flow diagrams are functors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>:</mo><mi>H</mi><mo>‚Üí</mo><mrow><mi>ùêÖ</mi><mi>ùê¢</mi><mi>ùêß</mi><mi>ùêí</mi><mi>ùêû</mi><mi>ùê≠</mi></mrow></mrow><annotation encoding="application/x-tex">F: H \to \mathbf{FinSet}</annotation></semantics></math>
from a primitive category
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>H</mi><annotation encoding="application/x-tex">H</annotation></semantics></math>
to finite sets, where:</p>
<ul>
<li>Objects:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mtext mathvariant="normal">stock</mtext><mo>,</mo><mtext mathvariant="normal">flow</mtext><mo>,</mo><mtext mathvariant="normal">link</mtext><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\text{stock}, \text{flow}, \text{link}\}</annotation></semantics></math>
</li>
<li>Morphisms:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>,</mo><mi>d</mi><mo>:</mo><mtext mathvariant="normal">flow</mtext><mo>‚Üí</mo><mtext mathvariant="normal">stock</mtext></mrow><annotation encoding="application/x-tex">u, d: \text{flow} \to \text{stock}</annotation></semantics></math>
(upstream/downstream) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>:</mo><mtext mathvariant="normal">link</mtext><mo>‚Üí</mo><mtext mathvariant="normal">stock</mtext></mrow><annotation encoding="application/x-tex">s: \text{link} \to \text{stock}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>:</mo><mtext mathvariant="normal">link</mtext><mo>‚Üí</mo><mtext mathvariant="normal">flow</mtext></mrow><annotation encoding="application/x-tex">t: \text{link} \to \text{flow}</annotation></semantics></math>
</li>
</ul>
<p>The <strong>ODE semantics</strong> for a stock
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œÉ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>œÉ</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><munder><mo>‚àë</mo><mrow><mi>f</mi><mo>‚àà</mo><mi>F</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>œÉ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></munder><msub><mi>œï</mi><mi>f</mi></msub><mo>‚àí</mo><munder><mo>‚àë</mo><mrow><mi>f</mi><mo>‚àà</mo><mi>F</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>œÉ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></munder><msub><mi>œï</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">\frac{d\sigma}{dt} = \sum_{f \in F(d)^{-1}(\sigma)} \phi_f - \sum_{f \in F(u)^{-1}(\sigma)} \phi_f</annotation></semantics></math></p>
<p>That is: rate of change = inflows - outflows.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-1-sir-epidemic-model">Example 1: SIR Epidemic Model<a class="anchor" aria-label="anchor" href="#example-1-sir-epidemic-model"></a>
</h2>
<p>The classic SIR (Susceptible-Infected-Recovered) model divides a
population into three compartments.</p>
<div class="section level3">
<h3 id="algebraic-api">Algebraic API<a class="anchor" aria-label="anchor" href="#algebraic-api"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define stocks</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"R"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define flows</span></span>
<span><span class="va">infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"infection"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span> <span class="op">/</span> <span class="fl">1000</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"recovery"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build diagram using %-&gt;% (connects) and %+% (combines)</span></span>
<span><span class="co"># Note: As of v0.2.0, stocks used in connections are automatically included!</span></span>
<span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">S</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">infection</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">I</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">I</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">recovery</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">R</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sir_diagram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">sir</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View diagram structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sir_diagram</span><span class="op">)</span></span>
<span><span class="co">#&gt; StockFlowDiagram</span></span>
<span><span class="co">#&gt;   Stocks: 3 </span></span>
<span><span class="co">#&gt;   Flows: 2 </span></span>
<span><span class="co">#&gt;   Links: 4 </span></span>
<span><span class="co">#&gt;   Variables: 0 </span></span>
<span><span class="co">#&gt;   Sum variables: 0</span></span></code></pre></div>
<p>The equations generated are: -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>S</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mo>‚àí</mo><mi>Œ≤</mi><mo>‚ãÖ</mo><mi>S</mi><mo>‚ãÖ</mo><mi>I</mi><mi>/</mi><mn>1000</mn></mrow><annotation encoding="application/x-tex">\frac{dS}{dt} = -\beta \cdot S \cdot I / 1000</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>I</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>Œ≤</mi><mo>‚ãÖ</mo><mi>S</mi><mo>‚ãÖ</mo><mi>I</mi><mi>/</mi><mn>1000</mn><mo>‚àí</mo><mi>Œ≥</mi><mo>‚ãÖ</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">\frac{dI}{dt} = \beta \cdot S \cdot I / 1000 - \gamma \cdot I</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>R</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>Œ≥</mi><mo>‚ãÖ</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">\frac{dR}{dt} = \gamma \cdot I</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="visualization">Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot diagram structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sir_diagram</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export to Graphviz DOT format</span></span>
<span><span class="va">dot_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/to_graphviz.html">to_graphviz</a></span><span class="op">(</span><span class="va">sir_diagram</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">dot_str</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With ggraph (if installed)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggraph.data-imaginist.com" class="external-link">ggraph</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sir_diagram</span>, layout <span class="op">=</span> <span class="st">"sugiyama"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"deSolve"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Solve ODE system</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span></span>
<span>    <span class="va">sir_diagram</span>,</span>
<span>    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># View results</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plot solution</span></span>
<span>  <span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">‚Ñπ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="introduction-algebraic_files/figure-html/sir_simulate-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="example-2-seir-model-with-population-conservation">Example 2: SEIR Model with Population Conservation<a class="anchor" aria-label="anchor" href="#example-2-seir-model-with-population-conservation"></a>
</h2>
<p>The SEIR model adds an Exposed (E) compartment and uses a sum
variable to track total population.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define stocks</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"E"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"R"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define flows</span></span>
<span><span class="va">infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"infection"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">S</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span> <span class="op">/</span> <span class="va">inputs</span><span class="op">$</span><span class="va">N</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">progression</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"progression"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">sigma</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">E</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"recovery"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">I</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build diagram (stocks automatically included from connections)</span></span>
<span><span class="va">seir_spec</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">S</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">infection</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">E</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">E</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">progression</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">I</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">I</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">recovery</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">R</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">seir_spec</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add sum variable for population conservation</span></span>
<span><span class="co"># Note: sum variables must be added after finalization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">seir</span> <span class="op">&lt;-</span> <span class="va">seir</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_sum_variable.html">add_sum_variable</a></span><span class="op">(</span><span class="st">"N"</span>, stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"E"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"N"</span>, to <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"I"</span>, to <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">seir</span><span class="op">)</span></span>
<span><span class="co">#&gt; StockFlowDiagram</span></span>
<span><span class="co">#&gt;   Stocks: 4 </span></span>
<span><span class="co">#&gt;   Flows: 3 </span></span>
<span><span class="co">#&gt;   Links: 8 </span></span>
<span><span class="co">#&gt;   Variables: 0 </span></span>
<span><span class="co">#&gt;   Sum variables: 1</span></span></code></pre></div>
<p>The equations are: -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>S</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mo>‚àí</mo><mi>Œ≤</mi><mo>‚ãÖ</mo><mi>S</mi><mo>‚ãÖ</mo><mi>I</mi><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\frac{dS}{dt} = -\beta \cdot S \cdot I / N</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>E</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>Œ≤</mi><mo>‚ãÖ</mo><mi>S</mi><mo>‚ãÖ</mo><mi>I</mi><mi>/</mi><mi>N</mi><mo>‚àí</mo><mi>œÉ</mi><mo>‚ãÖ</mo><mi>E</mi></mrow><annotation encoding="application/x-tex">\frac{dE}{dt} = \beta \cdot S \cdot I / N - \sigma \cdot E</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>I</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>œÉ</mi><mo>‚ãÖ</mo><mi>E</mi><mo>‚àí</mo><mi>Œ≥</mi><mo>‚ãÖ</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">\frac{dI}{dt} = \sigma \cdot E - \gamma \cdot I</annotation></semantics></math>
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>R</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>Œ≥</mi><mo>‚ãÖ</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">\frac{dR}{dt} = \gamma \cdot I</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>S</mi><mo>+</mo><mi>E</mi><mo>+</mo><mi>I</mi><mo>+</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">N = S + E + I + R</annotation></semantics></math>
remains constant.</p>
<div class="section level3">
<h3 id="seir-simulation">SEIR Simulation<a class="anchor" aria-label="anchor" href="#seir-simulation"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"deSolve"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">seir_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span></span>
<span>    <span class="va">seir</span>,</span>
<span>    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.5</span>, sigma <span class="op">=</span> <span class="fl">0.2</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Verify population conservation</span></span>
<span>  <span class="va">total_pop</span> <span class="op">&lt;-</span> <span class="va">seir_result</span><span class="op">$</span><span class="va">S</span> <span class="op">+</span> <span class="va">seir_result</span><span class="op">$</span><span class="va">E</span> <span class="op">+</span> <span class="va">seir_result</span><span class="op">$</span><span class="va">I</span> <span class="op">+</span> <span class="va">seir_result</span><span class="op">$</span><span class="va">R</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Population conservation:"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_pop</span> <span class="op">-</span> <span class="fl">1001</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-6</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plot dynamics</span></span>
<span>  <span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">seir_result</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Phase plot</span></span>
<span>  <span class="fu"><a href="../reference/phase_plot.html">phase_plot</a></span><span class="op">(</span><span class="va">seir_result</span>, <span class="st">"S"</span>, <span class="st">"I"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Population conservation: TRUE</span></span></code></pre></div>
<p><img src="introduction-algebraic_files/figure-html/seir_simulate-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="example-3-stock-and-flow-with-inflowsoutflows">Example 3: Stock and Flow with Inflows/Outflows<a class="anchor" aria-label="anchor" href="#example-3-stock-and-flow-with-inflowsoutflows"></a>
</h2>
<p>A water tank with constant inflow and proportional outflow.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define stock</span></span>
<span><span class="va">Water</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"Water"</span>, initial <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define flows</span></span>
<span><span class="va">fill</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"fill"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">inflow_rate</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">drain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"drain"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">outflow_rate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Water</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build diagram: NULL represents external source/sink</span></span>
<span><span class="co"># Water automatically included from connections</span></span>
<span><span class="va">tank_spec</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">fill</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">Water</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">Water</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">drain</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">tank_spec</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tank</span><span class="op">)</span></span>
<span><span class="co">#&gt; StockFlowDiagram</span></span>
<span><span class="co">#&gt;   Stocks: 1 </span></span>
<span><span class="co">#&gt;   Flows: 2 </span></span>
<span><span class="co">#&gt;   Links: 2 </span></span>
<span><span class="co">#&gt;   Variables: 0 </span></span>
<span><span class="co">#&gt;   Sum variables: 0</span></span></code></pre></div>
<p>At equilibrium, inflow = outflow:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">inflow_rate</mtext><mo>=</mo><mtext mathvariant="normal">outflow_rate</mtext><mo>√ó</mo><mtext mathvariant="normal">Water</mtext></mrow><annotation encoding="application/x-tex">\text{inflow\_rate} = \text{outflow\_rate} \times \text{Water}</annotation></semantics></math></p>
<p>So:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">Water</mtext><mtext mathvariant="normal">eq</mtext></msub><mo>=</mo><mfrac><mtext mathvariant="normal">inflow_rate</mtext><mtext mathvariant="normal">outflow_rate</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text{Water}_{\text{eq}} = \frac{\text{inflow\_rate}}{\text{outflow\_rate}}</annotation></semantics></math></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"deSolve"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tank_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span></span>
<span>    <span class="va">tank</span>,</span>
<span>    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>inflow_rate <span class="op">=</span> <span class="fl">10</span>, outflow_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Equilibrium should be 10 / 0.1 = 100</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Final water level:"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">tank_result</span><span class="op">$</span><span class="va">Water</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Expected equilibrium:"</span>, <span class="fl">10</span> <span class="op">/</span> <span class="fl">0.1</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">tank_result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Final water level: 99.6631 </span></span>
<span><span class="co">#&gt; Expected equilibrium: 100</span></span></code></pre></div>
<p><img src="introduction-algebraic_files/figure-html/tank_simulate-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level2">
<h2 id="example-4-auxiliary-variables">Example 4: Auxiliary Variables<a class="anchor" aria-label="anchor" href="#example-4-auxiliary-variables"></a>
</h2>
<p>Models can include auxiliary variables that depend on stocks or other
variables.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define stock</span></span>
<span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"Population"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define growth flow</span></span>
<span><span class="va">growth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"growth"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputs</span><span class="op">$</span><span class="va">GrowthRate</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Population</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build base diagram (P automatically included)</span></span>
<span><span class="va">growth_spec</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">growth</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">P</span></span>
<span><span class="va">growth_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">growth_spec</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add auxiliary variable and links after finalization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">growth_model</span> <span class="op">&lt;-</span> <span class="va">growth_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_variable.html">add_variable</a></span><span class="op">(</span><span class="st">"GrowthRate"</span>,</span>
<span>    expression <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">params</span>, <span class="va">var_values</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Growth rate decreases as population approaches carrying capacity</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">r</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">state</span><span class="op">[</span><span class="st">"Population"</span><span class="op">]</span> <span class="op">/</span> <span class="va">params</span><span class="op">$</span><span class="va">K</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"GrowthRate"</span>, to <span class="op">=</span> <span class="st">"growth"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"Population"</span>, to <span class="op">=</span> <span class="st">"growth"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">growth_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; StockFlowDiagram</span></span>
<span><span class="co">#&gt;   Stocks: 1 </span></span>
<span><span class="co">#&gt;   Flows: 1 </span></span>
<span><span class="co">#&gt;   Links: 3 </span></span>
<span><span class="co">#&gt;   Variables: 1 </span></span>
<span><span class="co">#&gt;   Sum variables: 0</span></span></code></pre></div>
<p>This implements logistic growth where the growth rate decreases as
population approaches carrying capacity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="algebraic-api-reference">Algebraic API Reference<a class="anchor" aria-label="anchor" href="#algebraic-api-reference"></a>
</h2>
<div class="section level3">
<h3 id="stock-creation">Stock Creation<a class="anchor" aria-label="anchor" href="#stock-creation"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"X"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>Creates a stock named ‚ÄúX‚Äù with initial value 100.</p>
</div>
<div class="section level3">
<h3 id="flow-creation">Flow Creation<a class="anchor" aria-label="anchor" href="#flow-creation"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"f"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Compute rate based on inputs and params</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">k</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">X</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Creates a flow named ‚Äúf‚Äù with a rate function.</p>
</div>
<div class="section level3">
<h3 id="connection-operator--">Connection Operator: <code>%-&gt;%</code><a class="anchor" aria-label="anchor" href="#connection-operator--"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">flow1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">B</span>  <span class="co"># Flow from stock A to stock B</span></span>
<span><span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">flow2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">C</span>  <span class="co"># External inflow to C</span></span>
<span><span class="va">D</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">flow3</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="cn">NULL</span>  <span class="co"># Outflow from D to external sink</span></span></code></pre></div>
<p>The <code>%-&gt;%</code> operator connects stocks and flows in
sequence.</p>
</div>
<div class="section level3">
<h3 id="combination-operator">Combination Operator: <code>%+%</code><a class="anchor" aria-label="anchor" href="#combination-operator"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Stocks automatically included from connections (v0.2.0+)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">stock1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">flow1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">stock2</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>         <span class="op">(</span><span class="va">stock2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">flow2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">stock1</span><span class="op">)</span></span></code></pre></div>
<p>The <code>%+%</code> operator combines components into a single model
specification. As of v0.2.0, stocks used in connections are
automatically included.</p>
</div>
<div class="section level3">
<h3 id="finalization">Finalization<a class="anchor" aria-label="anchor" href="#finalization"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">model</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Converts a model specification into a complete StockFlowDiagram.</p>
</div>
</div>
<div class="section level2">
<h2 id="workflow-summary">Workflow Summary<a class="anchor" aria-label="anchor" href="#workflow-summary"></a>
</h2>
<p>The typical workflow with the algebraic API is:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Define components</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"X"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"f"</span>, rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span> <span class="va">...</span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Connect and combine</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="op">(</span><span class="va">X</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Finalize</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">model</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Add auxiliary features (optional)</strong></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagram</span> <span class="op">&lt;-</span> <span class="va">diagram</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_variable.html">add_variable</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_sum_variable.html">add_sum_variable</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Solve with deSolve</strong></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span><span class="va">diagram</span>, <span class="va">times</span>, <span class="va">params</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Visualize and analyze</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diagram</span><span class="op">)</span>              <span class="co"># Structure</span></span>
<span><span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>      <span class="co"># Dynamics</span></span>
<span><span class="fu"><a href="../reference/phase_plot.html">phase_plot</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>  <span class="co"># State space</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="design-principles">Design Principles<a class="anchor" aria-label="anchor" href="#design-principles"></a>
</h2>
<div class="section level3">
<h3 id="compositional-by-design">Compositional by Design<a class="anchor" aria-label="anchor" href="#compositional-by-design"></a>
</h3>
<p>Stock-flow diagrams are represented as functors, enabling:</p>
<ul>
<li>
<strong>Local reasoning</strong>: Understand components
independently</li>
<li>
<strong>Categorical composition</strong>: Combine models via
decorated cospans</li>
<li>
<strong>Stratification</strong>: Refine models via pullbacks (e.g.,
by age, sex)</li>
</ul>
</div>
<div class="section level3">
<h3 id="type-safety">Type Safety<a class="anchor" aria-label="anchor" href="#type-safety"></a>
</h3>
<p>S4 classes with validation ensure:</p>
<ul>
<li>Stocks have finite initial values</li>
<li>Flows connect to existing stocks</li>
<li>Dependencies are well-formed</li>
</ul>
</div>
<div class="section level3">
<h3 id="functorial-semantics">Functorial Semantics<a class="anchor" aria-label="anchor" href="#functorial-semantics"></a>
</h3>
<p>Separation of concerns:</p>
<ul>
<li>
<strong>Syntax</strong>: Diagram structure (stocks, flows,
links)</li>
<li>
<strong>Semantics</strong>: ODE generation via
<code><a href="../reference/generate_ode.html">generate_ode()</a></code>
</li>
<li>
<strong>Solving</strong>: Numerical integration via deSolve</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="advanced-example-predator-prey-with-logistic-prey-growth">Advanced Example: Predator-Prey with Logistic Prey Growth<a class="anchor" aria-label="anchor" href="#advanced-example-predator-prey-with-logistic-prey-growth"></a>
</h2>
<p>Combining multiple patterns:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define stocks</span></span>
<span><span class="va">Prey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"Prey"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">Predator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"Predator"</span>, initial <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define flows</span></span>
<span><span class="va">prey_growth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"prey_growth"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Logistic growth with carrying capacity</span></span>
<span>    <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">r</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Prey</span> <span class="op">/</span> <span class="va">params</span><span class="op">$</span><span class="va">K</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">r</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Prey</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># Non-negative</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"predation"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">alpha</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Prey</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Predator</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predator_growth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"predator_growth"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Predators gain energy from prey</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">alpha</span> <span class="op">*</span> <span class="va">params</span><span class="op">$</span><span class="va">efficiency</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Prey</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Predator</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predator_death</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"predator_death"</span>,</span>
<span>  rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">params</span><span class="op">$</span><span class="va">delta</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">Predator</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build model</span></span>
<span><span class="va">pp_spec</span> <span class="op">&lt;-</span> <span class="va">Prey</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="va">Predator</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">prey_growth</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">Prey</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">Prey</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">predation</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">predator_growth</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">Predator</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>  <span class="op">(</span><span class="va">Predator</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">predator_death</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pp_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">pp_spec</span>, reset_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add missing links for flows that need inputs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">pp_model</span> <span class="op">&lt;-</span> <span class="va">pp_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"Predator"</span>, to <span class="op">=</span> <span class="st">"predation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"Prey"</span>, to <span class="op">=</span> <span class="st">"predator_growth"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_link.html">add_link</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"Predator"</span>, to <span class="op">=</span> <span class="st">"predator_growth"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pp_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; StockFlowDiagram</span></span>
<span><span class="co">#&gt;   Stocks: 2 </span></span>
<span><span class="co">#&gt;   Flows: 4 </span></span>
<span><span class="co">#&gt;   Links: 7 </span></span>
<span><span class="co">#&gt;   Variables: 0 </span></span>
<span><span class="co">#&gt;   Sum variables: 0</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"deSolve"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pp_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/solve_diagram.html">solve_diagram</a></span><span class="op">(</span></span>
<span>    <span class="va">pp_model</span>,</span>
<span>    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      r <span class="op">=</span> <span class="fl">0.5</span>,           <span class="co"># Prey growth rate</span></span>
<span>      K <span class="op">=</span> <span class="fl">500</span>,           <span class="co"># Prey carrying capacity</span></span>
<span>      alpha <span class="op">=</span> <span class="fl">0.01</span>,      <span class="co"># Predation rate</span></span>
<span>      efficiency <span class="op">=</span> <span class="fl">0.5</span>,  <span class="co"># Conversion efficiency</span></span>
<span>      delta <span class="op">=</span> <span class="fl">0.2</span>        <span class="co"># Predator death rate</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plot time series</span></span>
<span>  <span class="fu"><a href="../reference/plot_solution.html">plot_solution</a></span><span class="op">(</span><span class="va">pp_result</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Phase portrait</span></span>
<span>  <span class="fu"><a href="../reference/phase_plot.html">phase_plot</a></span><span class="op">(</span><span class="va">pp_result</span>, <span class="st">"Prey"</span>, <span class="st">"Predator"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="introduction-algebraic_files/figure-html/predator_prey_solve-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level2">
<h2 id="comparison-with-pipe-based-api">Comparison with Pipe-Based API<a class="anchor" aria-label="anchor" href="#comparison-with-pipe-based-api"></a>
</h2>
<p>The algebraic API and pipe-based API create identical underlying
models. Choose based on preference:</p>
<p><strong>Algebraic API</strong> (this guide):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define components</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"infection"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compose</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="va">I</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="op">(</span><span class="va">S</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">I</span><span class="op">)</span></span>
<span><span class="va">diagram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finalize.html">finalize</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<p><strong>Pipe-Based API</strong> (see introduction.Rmd):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build incrementally</span></span>
<span><span class="va">diagram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_flow_diagram.html">stock_flow_diagram</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"S"</span>, initial <span class="op">=</span> <span class="fl">999</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_stock.html">add_stock</a></span><span class="op">(</span><span class="st">"I"</span>, initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_flow.html">add_flow</a></span><span class="op">(</span><span class="st">"infection"</span>, from <span class="op">=</span> <span class="st">"S"</span>, to <span class="op">=</span> <span class="st">"I"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>Both produce the same <code>StockFlowDiagram</code> object.</p>
</div>
<div class="section level2">
<h2 id="tips-for-algebraic-api">Tips for Algebraic API<a class="anchor" aria-label="anchor" href="#tips-for-algebraic-api"></a>
</h2>
<ol style="list-style-type: decimal">
<li>
<strong>Define before connecting</strong>: Create all stocks and
flows before using <code>%-&gt;%</code>
</li>
<li>
<strong>Use parentheses</strong>: Group connections with parentheses
for clarity</li>
<li>
<strong>NULL for external</strong>: Use <code>NULL</code> for
external sources/sinks</li>
<li>
<strong>Finalize before adding auxiliary</strong>: Variables and
links must be added after finalization</li>
<li>
<strong>Reset IDs for reproducibility</strong>: Use
<code>reset_ids = TRUE</code> in finalize</li>
</ol>
</div>
<div class="section level2">
<h2 id="common-patterns">Common Patterns<a class="anchor" aria-label="anchor" href="#common-patterns"></a>
</h2>
<div class="section level3">
<h3 id="pattern-1-stock-with-self-loop">Pattern 1: Stock with Self-Loop<a class="anchor" aria-label="anchor" href="#pattern-1-stock-with-self-loop"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"X"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">growth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"growth"</span>, rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">params</span><span class="op">)</span> <span class="va">params</span><span class="op">$</span><span class="va">r</span> <span class="op">*</span> <span class="va">inputs</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="op">(</span><span class="cn">NULL</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">growth</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">X</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pattern-2-two-stocks-with-bidirectional-flow">Pattern 2: Two Stocks with Bidirectional Flow<a class="anchor" aria-label="anchor" href="#pattern-2-two-stocks-with-bidirectional-flow"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"A"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"B"</span>, initial <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"A_to_B"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"B_to_A"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="va">B</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="op">(</span><span class="va">A</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">B</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="op">(</span><span class="va">B</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">A</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pattern-3-chain-of-stocks">Pattern 3: Chain of Stocks<a class="anchor" aria-label="anchor" href="#pattern-3-chain-of-stocks"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S1"</span>, initial <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">S2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S2"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">S3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">stock</a></span><span class="op">(</span><span class="st">"S3"</span>, initial <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"f1"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flow.html">flow</a></span><span class="op">(</span><span class="st">"f2"</span>, rate <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">S1</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="va">S2</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span> <span class="va">S3</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>         <span class="op">(</span><span class="va">S1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f1</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">S2</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-plus-grapes.html">%+%</a></span></span>
<span>         <span class="op">(</span><span class="va">S2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">f2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%-&gt;%</a></span> <span class="va">S3</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong>Composition vignette</strong>: Learn to build complex models
from simpler components</li>
<li>
<strong>Mathematical foundations</strong>: Deep dive into category
theory and functorial semantics</li>
<li>
<strong>Quick start guide</strong>: Fast introduction for
beginners</li>
</ul>
</div>
<div class="section level2">
<h2 id="getting-help">Getting Help<a class="anchor" aria-label="anchor" href="#getting-help"></a>
</h2>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">stock</span>              <span class="co"># Stock creation</span></span>
<span><span class="op">?</span><span class="va">flow</span>               <span class="co"># Flow creation</span></span>
<span><span class="op">?</span><span class="va">`%-&gt;%`</span>             <span class="co"># Connection operator</span></span>
<span><span class="op">?</span><span class="va">`%+%`</span>              <span class="co"># Combination operator</span></span>
<span><span class="op">?</span><span class="va">finalize</span>           <span class="co"># Finalization</span></span>
<span><span class="op">?</span><span class="va">solve_diagram</span>      <span class="co"># Solving ODEs</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] magrittr_2.0.4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] crayon_1.5.3       vctrs_0.6.5        cli_3.6.5          knitr_1.51        </span></span>
<span><span class="co">#&gt;  [5] rlang_1.1.6        xfun_0.55          generics_0.1.4     S7_0.2.1          </span></span>
<span><span class="co">#&gt;  [9] textshaping_1.0.4  jsonlite_2.0.0     deSolve_1.40       labeling_0.4.3    </span></span>
<span><span class="co">#&gt; [13] glue_1.8.0         htmltools_0.5.9    ragg_1.5.0         sass_0.4.10       </span></span>
<span><span class="co">#&gt; [17] scales_1.4.0       rmarkdown_2.30     grid_4.5.2         tibble_3.3.0      </span></span>
<span><span class="co">#&gt; [21] evaluate_1.0.5     jquerylib_0.1.4    fastmap_1.2.0      yaml_2.3.12       </span></span>
<span><span class="co">#&gt; [25] lifecycle_1.0.4    compiler_4.5.2     dplyr_1.1.4        RColorBrewer_1.1-3</span></span>
<span><span class="co">#&gt; [29] fs_1.6.6           pkgconfig_2.0.3    farver_2.1.2       systemfonts_1.3.1 </span></span>
<span><span class="co">#&gt; [33] digest_0.6.39      R6_2.6.1           tidyselect_1.2.1   pillar_1.11.1     </span></span>
<span><span class="co">#&gt; [37] bslib_0.9.0        withr_3.0.2        tools_4.5.2        gtable_0.3.6      </span></span>
<span><span class="co">#&gt; [41] pkgdown_2.2.0      ggplot2_4.0.1      cachem_1.1.0       desc_1.4.3</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Moran.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
